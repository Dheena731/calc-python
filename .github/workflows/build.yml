name: Build, Test, SonarQube and OWASP ZAP

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-and-sonar:
    name: Test and SonarQube
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install runtime and test dependencies
        run: |
          python -m pip install --upgrade pip
          # install runtime deps (from requirements.txt) and test tools
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          pip install pytest pytest-cov

      - name: Run tests and generate coverage XML
        run: |
          mkdir -p coverage
          # produce coverage XML at coverage/coverage.xml expected by Sonar
          pytest --cov=src --cov-report=xml:coverage/coverage.xml --cov-branch

      - name: Optional -- Build Docker image (keeps parity with runtime)
        run: docker build -t calc-python:latest .

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # make sure the scanner looks for the coverage file we just created
          SONAR_SCANNER_OPTS: "-Dsonar.python.coverage.reportPaths=coverage/coverage.xml"

  zap-scan:
    name: OWASP ZAP scan (baseline)
    runs-on: ubuntu-latest
    needs: test-and-sonar
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t calc-python:latest .

      - name: Start application container (background)
        # Use host networking so ZAP can access the app via localhost
        run: |
          docker run -d --rm --name calc-app --network host calc-python:latest
      - name: Wait for app to be ready
        run: |
          # wait up to 60s for a 200 on / (adjust path as needed)
          for i in $(seq 1 60); do
            if curl -sSf http://127.0.0.1:8000/ > /dev/null; then
              echo "app is up"
              break
            fi
            sleep 1
          done

      - name: Run OWASP ZAP baseline scan
        run: |
          mkdir -p zap-report
          # Use the official ZAP docker image to run a baseline scan against the app
          docker run --network host --rm -v "${{ github.workspace }}/zap-report":/zap/report owasp/zap2docker-stable \
            zap-baseline.py -t http://127.0.0.1:8000 -r /zap/report/zap_report.html -I

      - name: Upload ZAP report artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report